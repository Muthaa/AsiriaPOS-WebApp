{% extends 'layouts/base.html' %}
{% load static %}
{% block title %}Inventory{% endblock title %}
{% block content %}

<div class="pc-container mt-4">
  <div class="pc-content">
    <div class="row">
      <!-- üßæ Inventory List -->
      <div class="col-lg-9 mb-4">
        <div class="card h-100">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Inventory List</h5>
            <div>
              <button class="btn btn-outline-primary btn-sm me-2" data-bs-toggle="modal" data-bs-target="#uploadCsvModal">
                <i class="ti ti-upload"></i> Upload CSV
              </button>
              <a href="{% url 'inventory' %}" class="btn btn-outline-secondary btn-sm me-2">
                <i class="ti ti-refresh"></i> Refresh
              </a>
              <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addProductModal">
                <i class="ti ti-plus"></i> Add Product
              </button>
            </div>
          </div>

          <div class="card-body">
            <form method="POST" action="{% url 'delete_products' %}" id="delete-products-form">
              {% csrf_token %}
              <div class="table-responsive">
                <table class="table table-bordered align-middle mb-0">
                  <thead class="table-light">
                    <tr>
                      <th><input type="checkbox" id="select-all"></th>
                      <th>Barcode</th>
                      <th>Name</th>
                      <th>SKU</th>
                      <th>Category</th>
                      <th>Stock</th>
                      <th>Min Qty</th>
                      <th>Cost</th>
                      <th>Price</th>
                      <th>Low Stock</th>
                      <th style="width: 90px;">Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% if products %}
                      {% for p in products %}
                        <tr>
                          <td><input type="checkbox" name="product_ids" value="{{ p.product_id }}"></td>
                          <td>{{ p.barcode }}</td>
                          <td>{{ p.name }}</td>
                          <td>{{ p.sku }}</td>
                          <td>{{ p.category_name }}</td>
                          <td>{{ p.stock }}</td>
                          <td>{{ p.minQuantity }}</td>
                          <td>{{ p.cost }}</td>
                          <td>{{ p.price }}</td>
                          <td>
                            {% if p.stock|add:"0" < p.minQuantity|add:"0" %}
                              <span class="badge bg-danger">Low</span>
                            {% else %}
                              <span class="badge bg-success">OK</span>
                            {% endif %}
                          </td>
                          <td>
                            <button type="button"
                                    class="btn btn-sm btn-outline-primary edit-btn"
                                    data-bs-toggle="modal"
                                    data-bs-target="#editProductModal"
                                    data-product='{
                                      "product_id": "{{ p.product_id }}",
                                      "name": "{{ p.name|escapejs }}",
                                      "sku": "{{ p.sku|escapejs }}",
                                      "barcode": "{{ p.barcode|escapejs }}",
                                      "description": "{{ p.description|default_if_none:''|escapejs }}",
                                      "category": "{{ p.category }}",
                                      "unit": "{{ p.unit }}",
                                      "minQuantity": "{{ p.minQuantity }}",
                                      "stock": "{{ p.stock }}",
                                      "cost": "{{ p.cost }}",
                                      "price": "{{ p.price }}"
                                    }'>
                              <i class="ti ti-edit"></i>
                            </button>
                          </td>
                        </tr>
                      {% endfor %}
                    {% else %}
                      <tr><td colspan="11" class="text-center text-muted">No products found.</td></tr>
                    {% endif %}
                  </tbody>
                </table>
              </div>
              

              <div class="mt-3">
                <button type="button" class="btn btn-danger btn-sm" id="delete-selected">
                  <i class="ti ti-trash"></i> Delete Selected
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- üìä Summary -->
      <div class="col-lg-3 mb-4">
        <div class="card h-100">
          <div class="card-header">
            <h6 class="mb-0">Summary</h6>
          </div>
          <div class="card-body">
            <ul class="list-group list-group-flush">
              <li class="list-group-item d-flex justify-content-between align-items-center">
                Total Products
                <span class="fw-bold">{{ products|length }}</span>
              </li>
              <li class="list-group-item d-flex justify-content-between align-items-center">
                Total Stock
                <span class="fw-bold">{{ total_stock }}</span>
              </li>
              <li class="list-group-item d-flex justify-content-between align-items-center">
                Low Stock
                <span class="fw-bold text-danger">{{ low_stock_count }}</span>
              </li>
            </ul>
          </div>

          <!-- Quick Actions -->
          <div class="card mt-4">
            <div class="card-header">
              <h6 class="mb-0">Quick Actions</h6>
            </div>
            <div class="card-body">
              <button class="btn btn-outline-secondary w-100 mb-2" data-bs-toggle="modal" data-bs-target="#addProductModal">
                <i class="ti ti-plus"></i> Add Product
              </button>
              <a href="{% url 'inventory' %}" class="btn btn-outline-primary w-100 mb-2">
                <i class="ti ti-refresh"></i> Refresh
              </a>
              <!-- Product Management Button -->
              <a href="{% url 'product_management' %}" class="btn btn-outline-success w-100">
                <i class="ti ti-settings"></i> Product Management
              </a>              
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- üßæ Add Product Modal -->
<div class="modal fade" id="addProductModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <form class="modal-content" method="POST" action="{% url 'add_product' %}">
      {% csrf_token %}
      <div class="modal-header">
        <h5 class="modal-title">Add Product</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        {% include "pages/includes/product_form.html" %}
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-primary">Save</button>
      </div>
    </form>
  </div>
</div>

<!-- ‚úèÔ∏è Edit Product Modal -->
<div class="modal fade" id="editProductModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <form class="modal-content" method="POST" id="edit-product-form">
      {% csrf_token %}
      <div class="modal-header">
        <h5 class="modal-title">Edit Product</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        {% include "pages/includes/product_form.html" %}
        <input type="hidden" name="product_id" id="edit-product-id">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-primary">Update</button>
      </div>
    </form>
  </div>
</div>

<!-- üìÇ CSV Upload Modal -->
<div class="modal fade" id="uploadCsvModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form class="modal-content" method="POST" action="{% url 'upload_products_csv' %}" enctype="multipart/form-data">
      {% csrf_token %}
      <div class="modal-header">
        <h5 class="modal-title">Upload Products (CSV)</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="file" name="file" class="form-control" accept=".csv" required>
        <small class="text-muted">Ensure your CSV has columns: name, category, unit, sku, barcode, description, minQuantity, price, cost, stock</small>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-primary">Upload</button>
      </div>
    </form>
  </div>
</div>

{% endblock content %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  // ‚úÖ Select All
  document.getElementById('select-all')?.addEventListener('change', function(e) {
    document.querySelectorAll('input[name="product_ids"]').forEach(ch => ch.checked = e.target.checked);
  });

  // üóëÔ∏è Delete Confirmation
  document.getElementById('delete-selected')?.addEventListener('click', function() {
    const checked = document.querySelectorAll('input[name="product_ids"]:checked');
    if (checked.length === 0) {
      Swal.fire({icon: 'info', title: 'No products selected'});
      return;
    }
    Swal.fire({
      icon: 'warning',
      title: 'Delete selected products?',
      text: `You are about to delete ${checked.length} products.`,
      showCancelButton: true,
      confirmButtonText: 'Yes, delete',
      cancelButtonText: 'Cancel'
    }).then(result => {
      if (result.isConfirmed) {
        document.getElementById('delete-products-form').submit();
      }
    });
  });

  // ‚úèÔ∏è Pre-fill Edit Modal
  document.querySelectorAll('.edit-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const raw = btn.getAttribute('data-product');
      let data = {};
      try { data = JSON.parse(raw); } catch (e) { console.error('Invalid product data', e); }

      // Set form action
      const form = document.getElementById('edit-product-form');
      form.action = `/inventory/edit/${data.product_id}/`;

      // Fill each field
      for (const [key, val] of Object.entries(data)) {
        const field = form.querySelector(`[name="${key}"]`);
        if (field) field.value = val ?? '';
      }

      // Select dropdowns
      if (data.category) form.querySelector('[name="category"]').value = data.category;
      if (data.unit) form.querySelector('[name="unit"]').value = data.unit;
    });
  });
</script>
{% endblock extra_js %}
