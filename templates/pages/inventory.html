{% extends 'layouts/base.html' %}
{% load static %}
{% block title %}Inventory{% endblock title %}
{% block content %}

{% if not api_online %}
  <div class="alert alert-warning">
    {{ error_message }}
  </div>
{% endif %}

<div class="pc-container mt-4">
  <div class="pc-content">
    <div class="row">
      <!-- ðŸ§¾ Inventory List -->
      <div class="col-lg-9 mb-4">
        <div class="card h-100">
          <div class="card-header d-flex flex-wrap justify-content-between align-items-center mb-3">
            <h4 class="fw-bold mb-2">Inventory List</h4>
            <div class="d-flex flex-wrap gap-2">

              <!-- Refresh -->
              <a href="{% url 'inventory' %}" class="btn btn-outline-primary btn-sm">
                <i class="ti ti-refresh"></i> Refresh
              </a>
              <!-- Add Product -->
              <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addProductModal">
                <i class="ti ti-plus"></i> Add Product
              </button>
            </div>
          </div>

          <div class="card-body">
            <!-- Search + Filter -->
            <div class="row mb-3 g-2">
              <div class="col-md-6">
                <input type="text" class="form-control" id="inventory-search" placeholder="ðŸ” Search products...">
              </div>
              <div class="col-md-3">
                <select id="filter-category" class="form-select">
                  <option value="">All Categories</option>
                  {% for cat in categories %}
                  <option value="{{ cat.name }}">{{ cat.name }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-md-3">
                <select id="filter-stock" class="form-select">
                  <option value="">All Stock</option>
                  <option value="low">Low Stock</option>
                  <option value="ok">OK</option>
                </select>
              </div>
            </div>
            <form method="POST" action="{% url 'delete_products' %}" id="delete-products-form">
              {% csrf_token %}
              <div class="table-responsive">
                <table id="inventory-table" class="table table-bordered align-middle mb-0">
                  <thead class="table-light">
                    <tr>
                      <th><input type="checkbox" id="select-all"></th>
                      <th class="sortable" data-key="barcode">Barcode</th>
                      <th class="sortable" data-key="name">Name</th>
                      <th class="sortable" data-key="sku">SKU</th>
                      <th class="sortable" data-key="category">Category</th>
                      <th class="sortable" data-key="stock" data-type="number">Stock</th>
                      <th class="sortable" data-key="minquantity" data-type="number">Min Qty</th>
                      <th class="sortable" data-key="cost" data-type="number">Cost</th>
                      <th class="sortable" data-key="price" data-type="number">Price</th>
                      <th>Low Stock</th>
                      <th style="width: 90px;">Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% if products %}
                      {% for p in products %}
                        <tr 
                          data-name="{{ p.name|lower }}" 
                          data-category="{{ p.category_name|lower }}" 
                          data-barcode="{{ p.barcode|lower }}" 
                          data-sku="{{ p.sku|lower }}"
                          data-stock="{{ p.stock|default:0 }}" 
                          data-minquantity="{{ p.minQuantity|default:0 }}"
                          data-cost="{{ p.cost|default:0 }}"
                          data-price="{{ p.price|default:0 }}">
                          <td><input type="checkbox" name="product_ids" value="{{ p.product_id }}"></td>
                          <td>{{ p.barcode }}</td>
                          <td>{{ p.name }}</td>
                          <td>{{ p.sku }}</td>
                          <td>{{ p.category_name }}</td>
                          <td>{{ p.stock }}</td>
                          <td>{{ p.minQuantity }}</td>
                          <td>{{ p.cost }}</td>
                          <td>{{ p.price }}</td>
                          <td>
                            {% if p.stock|add:"0" < p.minQuantity|add:"0" %}
                              <span class="badge bg-danger">Low</span>
                            {% else %}
                              <span class="badge bg-success">OK</span>
                            {% endif %}
                          </td>
                          <td>
                            <button type="button"
                                    class="btn btn-sm btn-outline-primary edit-btn"
                                    data-bs-toggle="modal"
                                    data-bs-target="#editProductModal"
                                    data-product='{
                                      "product_id": "{{ p.product_id }}",
                                      "name": "{{ p.name|escapejs }}",
                                      "sku": "{{ p.sku|escapejs }}",
                                      "barcode": "{{ p.barcode|escapejs }}",
                                      "description": "{{ p.description|default_if_none:''|escapejs }}",
                                      "category": "{{ p.category }}",
                                      "unit": "{{ p.unit }}",
                                      "minQuantity": "{{ p.minQuantity }}",
                                      "stock": "{{ p.stock }}",
                                      "cost": "{{ p.cost }}",
                                      "price": "{{ p.price }}"
                                    }'>
                              <i class="ti ti-edit"></i>
                            </button>
                          </td>
                        </tr>
                      {% endfor %}
                    {% else %}
                      <tr><td colspan="11" class="text-center text-muted">No products found.</td></tr>
                    {% endif %}
                  </tbody>                 
                </table>
              </div>
              
              <div class="mt-3">
                <button type="button" class="btn btn-danger btn-sm" id="delete-selected">
                  <i class="ti ti-trash"></i> Delete Selected
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- ðŸ“Š Summary -->
      <div class="col-lg-3 mb-4">
        <div class="card h-100">
          <!-- Quick Actions -->
          <div class="card mt-4">
            <div class="card-header">
              <h6 class="mb-0">Quick Actions</h6>
            </div>
            <div class="card-body">
              <!-- Product Management Button -->
              <a href="{% url 'product_management' %}" class="btn btn-outline-success w-100 mb-2">
                <i class="ti ti-settings"></i> Product Management
              </a>
              <!-- Upload CSV -->
              <button class="btn btn-outline-secondary w-100 mb-2 " data-bs-toggle="modal" data-bs-target="#uploadCsvModal">
                <i class="ti ti-upload"></i> Upload CSV
              </button>
              <!-- Export csv-->
              <button class="btn btn-outline-primary w-100 mb-2" id="export-btn">
                <i class="ti ti-download"></i> Export CSV
              </button>
              <!-- <a href="{% url 'inventory' %}" class="btn btn-outline-primary w-100 mb-2">
                <i class="ti ti-refresh"></i> Refresh
              </a> -->
            </div>
          </div>
          <div class="card-header">
            <h6 class="mb-0">Summary</h6>
          </div>
          <div class="card-body">
            <ul class="list-group list-group-flush">
              <li class="list-group-item d-flex justify-content-between align-items-center">
                Total Products
                <span class="fw-bold">{{ products|length }}</span>
              </li>
              <li class="list-group-item d-flex justify-content-between align-items-center">
                Total Stock
                <span class="fw-bold">{{ total_stock }}</span>
              </li>
              <li class="list-group-item d-flex justify-content-between align-items-center">
                Low Stock
                <span class="fw-bold text-danger">{{ low_stock_count }}</span>
              </li>
            </ul>
          </div>

          
        </div>
      </div>

    </div>
  </div>
</div>

<!-- Add Product Modal -->
{% include "pages/includes/add_product_modal.html" %}
<!-- Edit Product Modal -->
{% include "pages/includes/edit_product_modal.html" %}
<!-- Upload CSV Modal -->
{% include "pages/includes/upload_csv_modal.html" %}

{% endblock content %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  // âœ… Select All
  document.getElementById('select-all')?.addEventListener('change', function(e) {
    document.querySelectorAll('input[name="product_ids"]').forEach(ch => ch.checked = e.target.checked);
  });

  // ðŸ—‘ï¸ Delete Confirmation
  document.getElementById('delete-selected')?.addEventListener('click', function() {
    const checked = document.querySelectorAll('input[name="product_ids"]:checked');
    if (checked.length === 0) {
      Swal.fire({icon: 'info', title: 'No products selected'});
      return;
    }
    Swal.fire({
      icon: 'warning',
      title: 'Delete selected products?',
      text: `You are about to delete ${checked.length} products.`,
      showCancelButton: true,
      confirmButtonText: 'Yes, delete',
      cancelButtonText: 'Cancel'
    }).then(result => {
      if (result.isConfirmed) {
        document.getElementById('delete-products-form').submit();
      }
    });
  });

  // ðŸ” Search + Filter logic
  const searchInput = document.getElementById('inventory-search');
  const categoryFilter = document.getElementById('filter-category');
  const stockFilter = document.getElementById('filter-stock');
  const tableRows = document.querySelectorAll('#inventory-table tbody tr');
  
  function filterTable() {
    const search = searchInput.value.toLowerCase();
    const category = categoryFilter.value.toLowerCase();
    const stockFilterVal = stockFilter.value;
  
    tableRows.forEach(row => {
      const name = row.dataset.name.toLowerCase();
      const cat = row.dataset.category.toLowerCase();
      const barcode = row.dataset.barcode;
      const sku = row.dataset.sku;
      const stockVal = parseInt(row.dataset.stock);
      const minVal = parseInt(row.dataset.minquantity);

      let show = true;

      // if (search && !name.includes(search) && !cat.includes(search)) show = false;
      if (search) {
      const matchesSearch =
        name.includes(search) ||
        cat.includes(search) ||
        barcode.includes(search) ||
        sku.includes(search);
      if (!matchesSearch) show = false;
    }
      if (category && cat !== category) show = false;
      if (stockFilterVal === 'low' && stockVal > minVal) show = false;
      if (stockFilterVal === 'ok' && stockVal <= minVal) show = false;
  
      row.style.display = show ? '' : 'none';
    });
  }
  
  [searchInput, categoryFilter, stockFilter].forEach(el => el.addEventListener('input', filterTable));
  
  // ðŸ§­ Table Sorting
  document.querySelectorAll('.sortable').forEach(header => {
    header.addEventListener('click', () => {
      const key = header.dataset.key;
      const type = header.dataset.type || 'string';
      const rows = Array.from(document.querySelectorAll('#inventory-table tbody tr'));

      // Toggle sort direction
      const current = header.dataset.order || 'asc';
      const newOrder = current === 'asc' ? 'desc' : 'asc';
      header.dataset.order = newOrder;

      // Remove arrow icons from others
      document.querySelectorAll('.sortable').forEach(h => h.classList.remove('sorted-asc', 'sorted-desc'));
      header.classList.add(newOrder === 'asc' ? 'sorted-asc' : 'sorted-desc');

      // Sort logic
      rows.sort((a, b) => {
        const valA = a.dataset[key] || '';
        const valB = b.dataset[key] || '';
        if (type === 'number') {
          return newOrder === 'asc' ? valA - valB : valB - valA;
        }
        return newOrder === 'asc'
          ? valA.localeCompare(valB)
          : valB.localeCompare(valA);
      });

      // Re-append sorted rows
      const tbody = document.querySelector('#inventory-table tbody');
      tbody.innerHTML = '';
      rows.forEach(r => tbody.appendChild(r));
    });
  });

  // ðŸ“¦ Export to CSV
  document.getElementById('export-btn').addEventListener('click', () => {
    const rows = [['Barcode','Name','SKU','Category','Stock','Min Qty','Cost','Price','Status']];
    const tableRows = document.querySelectorAll('#inventory-table tbody tr');

    tableRows.forEach(r => {
      if (r.style.display !== 'none' && r.querySelector('td')) {
        rows.push([
          r.children[1].innerText, // Barcode
          r.children[2].innerText, // Name
          r.children[3].innerText, // SKU
          r.children[4].innerText, // Category
          r.children[5].innerText, // Stock
          r.children[6].innerText, // Min Qty
          r.children[7].innerText, // Cost
          r.children[8].innerText, // Price
          r.children[9].innerText  // Status
        ]);
      }
    });

    const csv = rows.map(e => e.join(',')).join('\n');
    const blob = new Blob([csv], { type: 'text/csv' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'inventory_export.csv';
    link.click();
  });
</script>

{% endblock extra_js %}
