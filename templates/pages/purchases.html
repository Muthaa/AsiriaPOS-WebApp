{% extends 'layouts/base.html' %}
{% load static %}
{% block title %} Purchases {% endblock title %}
{% block content %}
  <div class="pc-container mt-4">
    <div class="pc-content">
      <div class="row">
        <div class="col-lg-8">
          <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h5 class="mb-0">New Purchase Order</h5>
              <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addSupplierModal">
                <i class="ti ti-user-plus"></i> Add Supplier
              </button>
            </div>
            <div class="card-body">
              <form id="purchase-form">
                <div class="row mb-3">
                  <div class="col-md-6">
                    <label for="supplier" class="form-label">Supplier</label>
                    <select class="form-select" id="supplier" name="supplier" required>
                      <option value="">Select Supplier</option>
                      <option>Acme Supplies</option>
                      <option>Global Traders</option>
                      <option>FreshMart Ltd</option>
                    </select>
                  </div>
                  <div class="col-md-6">
                    <label for="purchase-date" class="form-label">Purchase Date</label>
                    <input type="date" class="form-control" id="purchase-date" name="purchase_date" required>
                  </div>
                </div>
                <div class="mb-3">
                  <label class="form-label">Add Products</label>
                  <div class="table-responsive">
                    <table class="table table-bordered align-middle mb-0" id="products-table">
                      <thead class="table-light">
                        <tr>
                          <th style="width: 30%;">Product</th>
                          <th style="width: 15%;">Quantity</th>
                          <th style="width: 20%;">Unit Price</th>
                          <th style="width: 20%;">Total</th>
                          <th style="width: 10%;"></th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr>
                          <td>
                            <input type="text" class="form-control" name="product_name[]" placeholder="Product name" required>
                          </td>
                          <td>
                            <input type="number" class="form-control" name="quantity[]" min="1" value="1" required>
                          </td>
                          <td>
                            <input type="number" class="form-control" name="unit_price[]" min="0" step="0.01" value="0.00" required>
                          </td>
                          <td>
                            <input type="text" class="form-control-plaintext" name="total[]" value="0.00" readonly>
                          </td>
                          <td>
                            <button type="button" class="btn btn-danger btn-sm remove-row" title="Remove"><i class="ti ti-trash"></i></button>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                  <button type="button" class="btn btn-outline-secondary btn-sm mt-2" id="add-product-row">
                    <i class="ti ti-plus"></i> Add Product
                  </button>
                </div>
                <div class="row mb-3">
                  <div class="col-md-6 offset-md-6">
                    <div class="d-flex justify-content-between">
                      <span class="fw-bold">Grand Total:</span>
                      <span class="fw-bold" id="grand-total">0.00</span>
                    </div>
                  </div>
                </div>
                <div class="d-flex justify-content-end">
                  <button type="submit" class="btn btn-success">
                    <i class="ti ti-check"></i> Save Purchase
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
        <!-- Suppliers List -->
        <div class="col-lg-4">
          <div class="card mb-4">
            <div class="card-header">
              <h6 class="mb-0">Suppliers</h6>
            </div>
            <div class="card-body p-0">
              <ul class="list-group list-group-flush" id="supplier-list">
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  Acme Supplies
                  <span class="badge bg-primary rounded-pill">3 Orders</span>
                </li>
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  Global Traders
                  <span class="badge bg-primary rounded-pill">5 Orders</span>
                </li>
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  FreshMart Ltd
                  <span class="badge bg-primary rounded-pill">2 Orders</span>
                </li>
              </ul>
            </div>
          </div>
          <div class="card">
            <div class="card-header">
              <h6 class="mb-0">Recent Purchases</h6>
            </div>
            <div class="card-body p-0">
              <ul class="list-group list-group-flush">
                <li class="list-group-item">
                  <div class="d-flex justify-content-between">
                    <span>Acme Supplies</span>
                    <span class="text-success">Ksh 12,000</span>
                  </div>
                  <small class="text-muted">2024-06-01</small>
                </li>
                <li class="list-group-item">
                  <div class="d-flex justify-content-between">
                    <span>Global Traders</span>
                    <span class="text-success">Ksh 8,500</span>
                  </div>
                  <small class="text-muted">2024-05-28</small>
                </li>
                <li class="list-group-item">
                  <div class="d-flex justify-content-between">
                    <span>FreshMart Ltd</span>
                    <span class="text-success">Ksh 4,200</span>
                  </div>
                  <small class="text-muted">2024-05-25</small>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Add Supplier Modal -->
  <div class="modal fade" id="addSupplierModal" tabindex="-1" aria-labelledby="addSupplierModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <form class="modal-content" id="add-supplier-form">
        <div class="modal-header">
          <h5 class="modal-title" id="addSupplierModalLabel">Add New Supplier</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="supplier-name" class="form-label">Supplier Name</label>
            <input type="text" class="form-control" id="supplier-name" required>
          </div>
          <div class="mb-3">
            <label for="supplier-contact" class="form-label">Contact Info</label>
            <input type="text" class="form-control" id="supplier-contact">
          </div>
          <div class="mb-3">
            <label for="supplier-address" class="form-label">Address</label>
            <input type="text" class="form-control" id="supplier-address">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Add Supplier</button>
        </div>
      </form>
    </div>
  </div>


{% endblock content %}
{% block extra_js %}
<script>
  // Add product row
  document.getElementById('add-product-row').addEventListener('click', function() {
    const table = document.getElementById('products-table').getElementsByTagName('tbody')[0];
    const newRow = table.rows[0].cloneNode(true);
    // Clear input values
    Array.from(newRow.querySelectorAll('input')).forEach(input => {
      if (input.type === 'number') input.value = input.name === 'quantity[]' ? 1 : 0.00;
      else input.value = '';
      if (input.name === 'total[]') input.value = '0.00';
    });
    table.appendChild(newRow);
  });

  // Remove product row
  document.getElementById('products-table').addEventListener('click', function(e) {
    if (e.target.closest('.remove-row')) {
      const row = e.target.closest('tr');
      const table = row.parentNode;
      if (table.rows.length > 1) {
        row.remove();
        updateTotals();
      }
    }
  });

  // Update totals on input
  document.getElementById('products-table').addEventListener('input', function(e) {
    if (['quantity[]', 'unit_price[]'].includes(e.target.name)) {
      updateTotals();
    }
  });

  function updateTotals() {
    let grandTotal = 0;
    const rows = document.querySelectorAll('#products-table tbody tr');
    rows.forEach(row => {
      const qty = parseFloat(row.querySelector('input[name="quantity[]"]').value) || 0;
      const price = parseFloat(row.querySelector('input[name="unit_price[]"]').value) || 0;
      const total = qty * price;
      row.querySelector('input[name="total[]"]').value = total.toFixed(2);
      grandTotal += total;
    });
    document.getElementById('grand-total').textContent = grandTotal.toFixed(2);
  }

  // Initial total calculation
  updateTotals();

  // Add Supplier Modal logic (demo only, not persistent)
  document.getElementById('add-supplier-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const name = document.getElementById('supplier-name').value.trim();
    if (name) {
      // Add to supplier select
      const supplierSelect = document.getElementById('supplier');
      const option = document.createElement('option');
      option.text = name;
      supplierSelect.add(option);
      // Add to supplier list
      const supplierList = document.getElementById('supplier-list');
      const li = document.createElement('li');
      li.className = "list-group-item d-flex justify-content-between align-items-center";
      li.innerHTML = `${name} <span class="badge bg-primary rounded-pill">0 Orders</span>`;
      supplierList.appendChild(li);
      // Close modal
      var modal = bootstrap.Modal.getInstance(document.getElementById('addSupplierModal'));
      modal.hide();
      this.reset();
    }
  });

  // Prevent form submission (demo only)
  document.getElementById('purchase-form').addEventListener('submit', function(e) {
    e.preventDefault();
    alert('Purchase saved! (Demo only)');
    this.reset();
    updateTotals();
  });
</script>
{% endblock extra_js %}
